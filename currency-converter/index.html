<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤šå¸ç§æ±‡ç‡è½¬æ¢å™¨</title>
    <script>
        const THEME_KEY = 'preferredTheme'; // possible values: 'system' | 'dark' | 'light'

        function getSystemTheme(){
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme){
            // theme: 'system'|'dark'|'light'
            const effective = theme === 'system' ? getSystemTheme() : theme;
            document.documentElement.setAttribute('data-theme', effective);
        }

        function loadThemeImmediately(){
            const saved = localStorage.getItem(THEME_KEY) || 'system';
            applyTheme(saved);
        }

        loadThemeImmediately();
    </script>
    <style>
      /* ä¸»é¢˜å˜é‡ï¼šåœ¨ :root ä¸­å®šä¹‰æµ…è‰²é»˜è®¤å€¼ï¼Œä½¿ç”¨ [data-theme="dark"] è¦†ç›–æ·±è‰² */
      :root{
        /* æµ…è‰²ä¸»é¢˜ï¼šæ·¡è“è‰²ä¸»è°ƒ */
        --bg-gradient-1: #e6f4ff;
        --bg-gradient-2: #ffffff;
        --header-grad-1: #6eb1da;
        --header-grad-2: #3382cc;
        --text-color: #24374a;
        --muted: #5a6f82;
        --card-bg: #ffffff;
        --card-border: #d6e8f7;
        --input-bg: #f2f8fd;
        --accent: #3a8edb;
        --status-loading-bg: #e9f4ff;
        --status-loading-color: #1e6bb8;
        --status-success-bg: #ebf9f0;
        --status-success-color: #2e7d32;
        --status-error-bg: #fdecea;
        --status-error-color: #c62828;
        --spinner-border: #3a8edb;
        --shadow: rgba(0,0,0,0.08);
        --handle-color: #a0a0a0; /* æ‹–æ‹½æ‰‹æŸ„é¢œè‰² */
        /* æ–°å¢ï¼šç»Ÿè®¡æ•°æ®é¢œè‰² */
        --stat-positive: #2e7d32;
        --stat-negative: #c62828;
        --stat-neutral: #5a6f82;
      }

      /* æ·±è‰²ä¸»é¢˜ï¼šé»‘é‡‘è‰² */
      [data-theme="dark"]{
        --bg-gradient-1: #000000;
        --bg-gradient-2: #1a1a1a;
        --header-grad-1: rgb(46, 36, 5);
        --header-grad-2: #1a1600ff;
        --text-color: #f0d479;  /* é‡‘è‰²å­—ä½“ */
        --muted: #bda65d;  /* æŸ”å’Œé‡‘è‰² */
        --card-bg: #111111;
        --card-border: rgba(255,215,0,0.15);
        --input-bg: #1b1b1b;
        --accent: #ffd700;  /* é‡‘è‰²ç‚¹ç¼€ */
        --status-loading-bg: rgba(255,215,0,0.08);
        --status-loading-color: #ffd700;
        --status-success-bg: rgba(46,125,50,0.15);
        --status-success-color: #7bd38a;
        --status-error-bg: rgba(198,40,40,0.15);
        --status-error-color: #ff8a80;
        --spinner-border: #ffd700;
        --shadow: rgba(0,0,0,0.7);
        --handle-color: #bda65d; /* æ‹–æ‹½æ‰‹æŸ„é¢œè‰² */
        /* æ–°å¢ï¼šç»Ÿè®¡æ•°æ®é¢œè‰² */
        --stat-positive: #7bd38a;
        --stat-negative: #ff8a80;
        --stat-neutral: #bda65d;
      }


      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
        min-height: 100vh;
        padding: 20px;
        color: var(--text-color);
        -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
        transition: background 300ms ease, color 300ms ease;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: 18px;
        box-shadow: 0 10px 25px var(--shadow);
        overflow: hidden;
        border: 1px solid var(--card-border);
        transition: background 300ms ease, border-color 300ms ease;
      }
      .header {
        background: linear-gradient(135deg, var(--header-grad-1) 0%, var(--header-grad-2) 100%);
        color: white;
        text-align: center;
        padding: 30px;
        position: relative;
      }

      .header .refresh-btn {
          margin: 15px auto 0;
          padding: 8px 20px;
          font-size: 0.95em;
          border-radius: 20px;
      }

      .header h1 { font-size: 2.3em; margin-bottom: 8px; }
      .header p { font-size: 1.1em; opacity: 0.95; }

      /* å³ä¸Šè§’ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
      .theme-toggle {
        position: absolute; right: 18px; top: 18px;
        background: rgba(255,255,255,0.12); border: none; color: white;
        padding: 8px 12px; border-radius: 12px; cursor: pointer;
        display:flex; align-items:center; gap:8px; font-weight:600;
        backdrop-filter: blur(6px);
        transition: transform .18s ease, background .18s ease;
      }
      .theme-toggle:hover{ transform: translateY(-3px); }
      [data-theme="dark"] .theme-toggle{ background: rgba(255,255,255,0.06); }

      .content { padding: 30px; }
      .status {
        text-align: center;
        margin-bottom: 20px;
        padding: 14px;
        border-radius: 10px;
        font-weight: 500;
      }
      .status.loading { background: var(--status-loading-bg); color: var(--status-loading-color); }
      .status.success { background: var(--status-success-bg); color: var(--status-success-color); }
      .status.error { background: var(--status-error-bg); color: var(--status-error-color); }
      .currency-list { display: flex; flex-direction: column; gap: 15px; }
      .currency-item {
        display: flex; align-items: center; justify-content: space-between;
        background: var(--card-bg); border-radius: 12px; padding: 15px 20px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        border: 1px solid var(--card-border); transition: all 0.25s ease;
        cursor: default; /* é»˜è®¤ä¸å¯æ‹–æ‹½ */
      }
      /* å¯æ‹–æ‹½æ‰‹æŸ„æ ·å¼ */
      .drag-handle {
          cursor: grab;
          font-size: 1.2em;
          color: var(--handle-color);
          margin-right: 15px;
          flex-shrink: 0;
      }
      .drag-handle:active {
          cursor: grabbing;
      }
      /* æ‹–æ‹½æ—¶çš„æ ·å¼ï¼ˆSortableJS ç±»ï¼‰ */
      .currency-item.sortable-ghost {
          opacity: 0.2;
          background-color: var(--accent);
          border: 1px dashed var(--accent);
      }
      .currency-item:hover {
        border-color: var(--accent);
        background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
        /* transform: translateY(-2px); /* ç§»é™¤ hover åŠ¨ç”»ä»¥é¿å…ä¸æ‹–æ‹½å†²çª */
      }
      .currency-left { display: flex; align-items: center; gap: 12px; }
      .flag { width: 36px; height: 24px; border-radius: 4px; object-fit: cover; }
      .currency-info { display: flex; flex-direction: column; }
      .currency-code { font-size: 1.1em; font-weight: 700; }
      .currency-name { font-size: 0.85em; color: var(--muted); }
      .currency-middle {
        flex: 1; text-align: center; font-size: 0.9em;
        color: var(--text-color); cursor: pointer;
      }
      .currency-middle:hover { color: var(--accent); }
      .currency-right { flex-shrink: 0; width: 180px; }
      .currency-input {
        width: 100%; padding: 10px 14px; font-size: 1.05em;
        border: 1px solid var(--card-border); border-radius: 8px;
        background: var(--input-bg); text-align: right; font-weight: 600;
        transition: 0.2s;
        color: var(--text-color);
      }
      .currency-input::placeholder{ color: var(--muted); }
      .currency-input:focus {
        outline: none; border-color: var(--accent); background: var(--card-bg);
        box-shadow: 0 0 0 3px rgba(109,213,237,0.08);
      }
      .last-updated {
        text-align: center; color: var(--muted); font-size: 0.9em;
        margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px;
      }
      .refresh-btn {
        display: block; margin: 20px auto 0; padding: 12px 30px;
        background: linear-gradient(135deg, var(--header-grad-1) 0%, var(--header-grad-2) 100%);
        color: white; border: none; border-radius: 25px;
        font-size: 1em; font-weight: 600; cursor: pointer;
        box-shadow: 0 4px 12px rgba(33,147,176,0.25);
        transition: transform 0.2s ease;
      }
      .refresh-btn:hover { transform: translateY(-2px); }
      .refresh-btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .spinner {
        display: inline-block; width: 16px; height: 16px;
        border: 2px solid var(--spinner-border); border-radius: 50%;
        border-top-color: transparent; animation: spin 1s linear infinite;
        margin-right: 6px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      .history-modal {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.45);
        display:flex; justify-content:center; align-items:center;
        z-index:1000; opacity:0; visibility:hidden; transition:0.3s;
      }
      .history-modal.active {
        opacity: 1; visibility: visible; backdrop-filter: blur(6px);
      }
      .modal-content {
        background:var(--card-bg); padding:25px; border-radius:15px;
        width:90%; max-width:750px; transform:scale(0.9); transition:0.3s; /* æ‰©å¤§æ¨¡æ€æ¡†å®½åº¦ */
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        border: 1px solid var(--card-border);
        color: var(--text-color);
      }
      .history-modal.active .modal-content { transform:scale(1); }
      .modal-header {
        display:flex; justify-content:space-between;
        align-items:center; margin-bottom:15px;
      }
      .modal-close {
        border:none; background:none; font-size:1.5em;
        cursor:pointer; color:var(--muted); transition: 0.2s;
      }
      .modal-close:hover { color:var(--accent); }

      /* æ–°å¢æ ·å¼ï¼šæ—¶é—´èŒƒå›´æŒ‰é’® */
      .time-range-buttons {
        display: flex; gap: 10px; margin-bottom: 20px;
        justify-content: center;
      }
      .time-range-buttons button {
        padding: 8px 15px; border-radius: 15px; border: 1px solid var(--card-border);
        background: var(--input-bg); color: var(--text-color);
        cursor: pointer; font-weight: 500; transition: background 0.2s, border-color 0.2s;
      }
      .time-range-buttons button:hover {
        border-color: var(--accent);
      }
      .time-range-buttons button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      /* æ–°å¢æ ·å¼ï¼šç»Ÿè®¡æ•°æ® */
      .history-stats {
        display: flex; justify-content: space-around;
        text-align: center; margin-top: 15px;
        padding: 10px 0; border-top: 1px solid var(--card-border);
        font-size: 0.9em;
      }
      .stat-item { flex: 1; padding: 0 5px; }
      .stat-value { font-size: 1.1em; font-weight: 700; margin-top: 3px; }
      .stat-high { color: var(--stat-positive); }
      .stat-low { color: var(--stat-negative); }
      .stat-change-up { color: var(--stat-positive); }
      .stat-change-down { color: var(--stat-negative); }
      .stat-change-neutral { color: var(--stat-neutral); }


      @media(max-width:768px){
        .currency-item{flex-direction:column;align-items:flex-start;}
        .currency-middle{text-align:left;margin:8px 0;}
        .currency-right{width:100%;}
        .theme-toggle{ right: 12px; top: 12px; }
        .history-stats{flex-wrap: wrap;}
        .stat-item{width: 50%; margin-bottom: 10px;}
        .time-range-buttons{flex-wrap: wrap;}
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’± å®æ—¶æ±‡ç‡è½¬æ¢å™¨</h1>
            <p>æ”¯æŒå¤šå¸ç§å®æ—¶è½¬æ¢ï¼Œæ•°æ®æ¥æºäºå¤šä¸ªæƒå¨æ±‡ç‡API</p>

            <button id="themeToggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜" title="å•å‡»åˆ‡æ¢ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿ â†’ æ·±è‰² â†’ æµ…è‰²ï¼‰">ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ</button>

            <button id="refreshBtn" class="refresh-btn" onclick="refreshRates()">ğŸ”„ åˆ·æ–°æ±‡ç‡</button>
        </div>
        <div class="content">
            <div id="status" class="status loading"><div class="spinner"></div> æ­£åœ¨è·å–æœ€æ–°æ±‡ç‡æ•°æ®...</div>
            <div id="currencyList" class="currency-list"></div>
            <div id="lastUpdated" class="last-updated">æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: è·å–ä¸­...</div>
        </div>
    </div>

    <div id="historyModal" class="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>

            <div class="time-range-buttons" id="timeRangeButtons">
                <button data-days="5" onclick="loadHistory(currentTarget, 5)">5å¤©</button>
                <button data-days="30" class="active" onclick="loadHistory(currentTarget, 30)">30å¤©</button>
                <button data-days="365" onclick="loadHistory(currentTarget, 365)">1å¹´</button>
                <button data-days="1825" onclick="loadHistory(currentTarget, 1825)">5å¹´</button>
            </div>

            <div style="height:350px;"><canvas id="historyChart"></canvas></div>

            <div id="historyStats" class="history-stats"></div>
        </div>
    </div>

    <script>
// æ›¿æ¢åçš„ <script> å†…å®¹

      /* ------------------- ä¸»é¢˜æ§åˆ¶ï¼ˆUI æ›´æ–°ï¼‰ ------------------- */
      // getSystemTheme, applyTheme, THEME_KEY åœ¨ head ä¸­å®šä¹‰

      function updateThemeToggleUI(savedTheme, effective){
        const btn = document.getElementById('themeToggle');
        let label = '';
        if(savedTheme === 'system') label = 'ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ';
        else if(savedTheme === 'dark') label = 'ğŸŒ™ æ·±è‰²';
        else label = 'ğŸŒ æµ…è‰²';
        btn.innerText = label;
        btn.title = `å½“å‰: ${label}ï¼ˆæ˜¾ç¤º: ${effective === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}ï¼‰ã€‚å•å‡»åˆ‡æ¢ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿ â†’ æ·±è‰² â†’ æµ…è‰²ï¼‰`;
      }

      function loadThemeUI(){
          const saved = localStorage.getItem(THEME_KEY) || 'system';
          const effective = saved === 'system' ? getSystemTheme() : saved;
          updateThemeToggleUI(saved, effective);
      }

      function cycleTheme(){
        const cur = localStorage.getItem(THEME_KEY) || 'system';
        const next = cur === 'system' ? 'dark' : cur === 'dark' ? 'light' : 'system';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next); // è°ƒç”¨å¤´éƒ¨çš„ applyTheme
        const effective = next === 'system' ? getSystemTheme() : next;
        updateThemeToggleUI(next, effective); // æ›´æ–° UI
      }

      // å½“ç³»ç»Ÿæ·±æµ…è‰²æ¨¡å¼æ”¹å˜æ—¶ï¼Œå¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯è·Ÿéšç³»ç»Ÿï¼ˆsystemï¼‰ï¼Œå°±è‡ªåŠ¨æ›´æ–°
      const mediaQuery = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      if(mediaQuery){
        try{ mediaQuery.addEventListener('change', () => {
            const saved = localStorage.getItem(THEME_KEY) || 'system';
            if(saved === 'system') {
                applyTheme('system');
                loadThemeUI(); // ç³»ç»Ÿæ¨¡å¼å˜åŒ–æ—¶ä¹Ÿè¦æ›´æ–° UI
            }
        }); }
        catch(e){ /* è€æµè§ˆå™¨ */ mediaQuery.addListener(() => {
            const saved = localStorage.getItem(THEME_KEY) || 'system';
            if(saved === 'system') {
                applyTheme('system');
                loadThemeUI(); // ç³»ç»Ÿæ¨¡å¼å˜åŒ–æ—¶ä¹Ÿè¦æ›´æ–° UI
            }
        }); }
      }

      // ç¡®ä¿ DOM åŠ è½½åå†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      window.addEventListener('load', () => {
        document.getElementById('themeToggle').addEventListener('click', cycleTheme);
      });

      /* ------------------- æ ¸å¿ƒç¨‹åºï¼ˆæ±‡ç‡ & æ‹–æ‹½æ’åºï¼‰ ------------------- */
      const CURRENCY_ORDER_KEY = 'currencyOrder'; // æ–°å¢ï¼šç”¨äºå­˜å‚¨æ’åºçš„ LocalStorage Key

      // åŸå§‹å¸ç§åˆ—è¡¨ï¼ˆç°åœ¨æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œç”¨äºæŸ¥æ‰¾è¯¦ç»†ä¿¡æ¯ï¼‰
      const allCurrenciesMap = {
        USD:{name:'ç¾å…ƒ',country:'us'}, EUR:{name:'æ¬§å…ƒ',country:'eu'}, CNY:{name:'äººæ°‘å¸',country:'cn'},
        JPY:{name:'æ—¥å…ƒ',country:'jp'}, GBP:{name:'è‹±é•‘',country:'gb'}, AUD:{name:'æ¾³å…ƒ',country:'au'},
        CAD:{name:'åŠ å…ƒ',country:'ca'}, CHF:{name:'ç‘å£«æ³•éƒ',country:'ch'}, HKD:{name:'æ¸¯å¸',country:'hk'},
        SGD:{name:'æ–°åŠ å¡å…ƒ',country:'sg'}, KRW:{name:'éŸ©å…ƒ',country:'kr'}, INR:{name:'å°åº¦å¢æ¯”',country:'in'},
        THB:{name:'æ³°é“¢',country:'th'}, VND:{name:'è¶Šå—ç›¾',country:'vn'}, RUB:{name:'ä¿„ç½—æ–¯å¢å¸ƒ',country:'ru'},
        ZAR:{name:'å—éå…°ç‰¹',country:'za'}, TWD:{name:'æ–°å°å¸',country:'tw'}, IDR:{name:'å°å°¼ç›¾',country:'id'},
        MYR:{name:'é©¬æ¥è¥¿äºšæ—å‰ç‰¹',country:'my'}, PHP:{name:'è²å¾‹å®¾æ¯”ç´¢',country:'ph'},
        TRY:{name:'åœŸè€³å…¶é‡Œæ‹‰',country:'tr'}
      };

      let currentCurrencyCodes = Object.keys(allCurrenciesMap); // å­˜å‚¨å½“å‰å±•ç¤ºçš„å¸ç§ä»£ç æ•°ç»„ï¼ˆç”¨äºæ’åºï¼‰
      let exchangeRates = {}, baseCurrency = 'USD', isUpdating = false, myChart = null;
      let currentTarget = null; // æ–°å¢ï¼šå­˜å‚¨å½“å‰æŸ¥çœ‹å†å²æ•°æ®çš„ç›®æ ‡è´§å¸ä»£ç 

      // å®æ—¶æ±‡ç‡æ•°æ®æºé˜Ÿåˆ—ï¼šæŒ‰ä¼˜å…ˆçº§æ’åº
      const rateSources = [
        // Source 1: ExchangeRate-API (USD Base) - ä½ çš„åŸå§‹æºï¼Œä¼˜å…ˆå°è¯•
        {
          name: 'ExchangeRate-API',
          url: 'https://api.exchangerate-api.com/v4/latest/USD',
          parseRates: d => d.rates,
          isUSD: true
        },
        // Source 2: Frankfurter (EUR Base) - å¤‡ç”¨æº
        {
          name: 'Frankfurter',
          url: 'https://api.frankfurter.app/latest',
          parseRates: d => d.rates,
          isUSD: false // åŸºç¡€è´§å¸æ˜¯ EUR
        }
      ];

      // å†å²æ•°æ® API (ç›®å‰ä»…ä¿ç•™ Frankfurter)
      const historyApi = {
        url:'https://api.frankfurter.app',
        // ä¼˜åŒ–åçš„ fetchHistory: ä¸€æ¬¡æ€§è·å–æŒ‡å®šæ—¥æœŸèŒƒå›´æ•°æ®
        fetchHistory:async(base,target,days)=>{
          const today = new Date();
          // Frankfurter API ä¸æ”¯æŒå½“å¤©æ•°æ®ï¼Œæ‰€ä»¥ endDate è®¾ä¸ºæ˜¨å¤©
          const end = new Date(); end.setDate(today.getDate()-1);
          const start = new Date(); start.setDate(today.getDate()-days);
          const s=start.toISOString().split('T')[0], e=end.toISOString().split('T')[0];

          try{
            // 1. è·å–ç›®æ ‡è´§å¸å…‘ EUR çš„å†å²æ•°æ® (EUR -> Target)
            const rt=await fetch(`${historyApi.url}/${s}..${e}?from=EUR&to=${target}`);
            if(!rt.ok) throw new Error("Target history fetch failed");
            const dt=await rt.json();
            const targetRates = dt.rates;

            let finalRates = [];

            if(base==='EUR'){
              // Case 1: Base is EUR
              finalRates = Object.keys(targetRates).map(dtKey=>{
                return {date:dtKey, rate:targetRates[dtKey][target]};
              }).filter(d=>d.rate).sort((a,b)=>new Date(a.date)-new Date(b.date)); // æ’åºç¡®ä¿æ—¶é—´é¡ºåº

            }else{
              // Case 2: Base is not EUR, calculate using EUR intermediary: (EUR -> Target) / (EUR -> Base)
              // 2. è·å–åŸºå‡†è´§å¸å…‘ EUR çš„å†å²æ•°æ® (EUR -> Base)
              const rb=await fetch(`${historyApi.url}/${s}..${e}?from=EUR&to=${base}`);
              if(!rb.ok) throw new Error("Base history fetch failed");
              const db=await rb.json();
              const baseRates = db.rates;

              finalRates = Object.keys(targetRates).map(dtKey=>{
                const targetRate = targetRates[dtKey] ? targetRates[dtKey][target] : null;
                const baseRate = baseRates[dtKey] ? baseRates[dtKey][base] : null;

                if(targetRate && baseRate){
                  return {date:dtKey, rate:targetRate/baseRate};
                }
                return null;
              }).filter(Boolean).sort((a,b)=>new Date(a.date)-new Date(b.date));
            }

            // è¡¥å……å½“å¤©çš„å®æ—¶æ•°æ®ä½œä¸ºæœ€åä¸€ä¸ªç‚¹ (å¦‚æœæœ‰çš„è¯)
            const currentRate = exchangeRates[target] / exchangeRates[base];
            if(currentRate && finalRates.length > 0){
                finalRates.push({
                    date: today.toISOString().split('T')[0],
                    rate: currentRate
                });
            }

            return finalRates;

          }catch(e){
            console.error("å†å²æ•°æ®è·å–å¤±è´¥:", e);
            throw new Error("å†å²æ•°æ®è·å–å¤±è´¥");
          }
        }
      };

      // --- æ‹–æ‹½æ’åºç›¸å…³é€»è¾‘ ---

      // åŠ è½½ç¼“å­˜çš„æ’åº
      function loadOrder(){
        const savedOrder = localStorage.getItem(CURRENCY_ORDER_KEY);
        if(savedOrder){
          try{
            const savedCodes = JSON.parse(savedOrder);
            // è¿‡æ»¤æ‰ä¸å†æ”¯æŒçš„å¸ç§ï¼Œå¹¶ç¡®ä¿åŒ…å«æ‰€æœ‰å½“å‰å¸ç§
            const newOrder = savedCodes.filter(code => allCurrenciesMap[code]);
            const missingCodes = Object.keys(allCurrenciesMap).filter(code => !newOrder.includes(code));
            currentCurrencyCodes = [...newOrder, ...missingCodes];
          }catch(e){
            console.error("åŠ è½½æ’åºå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é¡ºåº:", e);
            currentCurrencyCodes = Object.keys(allCurrenciesMap);
          }
        } else {
            currentCurrencyCodes = Object.keys(allCurrenciesMap);
        }
      }

      // ä¿å­˜å½“å‰æ’åº
      function saveOrder(){
        // currentCurrencyCodes å·²ç»æ˜¯åœ¨ onEnd äº‹ä»¶ä¸­æ›´æ–°åçš„é¡ºåº
        localStorage.setItem(CURRENCY_ORDER_KEY, JSON.stringify(currentCurrencyCodes));
      }

      // åˆå§‹åŒ– SortableJS
      function initSortable(){
        const list = document.getElementById('currencyList');
        Sortable.create(list, {
          animation: 150,
          handle: '.drag-handle', // æ‹–æ‹½æ‰‹æŸ„ç±»å
          ghostClass: 'sortable-ghost', // æ‹–æ‹½æ—¶å¹½çµå…ƒç´ çš„ç±»å (CSS ä¸­å·²å®šä¹‰)
          onEnd: function (evt) {
            // æ›´æ–° currentCurrencyCodes æ•°ç»„
            const item = currentCurrencyCodes[evt.oldIndex];
            currentCurrencyCodes.splice(evt.oldIndex, 1);
            currentCurrencyCodes.splice(evt.newIndex, 0, item);

            saveOrder(); // ä¿å­˜æ–°çš„æ’åºåˆ° LocalStorage

            // é‡æ–°è®¡ç®—æ±‡ç‡ï¼ˆç¡®ä¿åŸºå‡†è´§å¸ä»ç„¶æœ‰æ•ˆï¼‰
            updateRateDisplays();
            const activeInputCode = currentCurrencyCodes.find(k=>{
              const val = document.getElementById(`input-${k}`).value.replace(/,/g,'');
              return parseFloat(val) > 0;
            });
            if(activeInputCode) onInputChange(activeInputCode);
          },
        });
      }

      // --- æ±‡ç‡è½¬æ¢åŠæ¸²æŸ“é€»è¾‘ ---

      function formatNumber(num){
        if(isNaN(num)) return '';
        return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }

      function createCurrencyItems(){
        const list=document.getElementById('currencyList'); list.innerHTML='';
        // ä½¿ç”¨ currentCurrencyCodes æ•°ç»„è¿›è¡Œæ¸²æŸ“
        currentCurrencyCodes.forEach(code=>{
          const info = allCurrenciesMap[code];
          if(!info) return; // ç•¥è¿‡æ— æ•ˆå¸ç§

          list.innerHTML+=`
            <div class="currency-item" data-code="${code}">
              <span class="drag-handle" title="æ‹–æ‹½ä»¥é‡æ–°æ’åº">â‹®â‹®</span> <div class="currency-left">
                <img src="https://flagcdn.com/w40/${info.country}.png" class="flag" alt="${code}">
                <div class="currency-info"><div class="currency-code">${code}</div><div class="currency-name">${info.name}</div></div>
              </div>
              <div class="currency-middle" id="rate-${code}" onclick="showHistoryChart('${code}')">æ±‡ç‡: åŠ è½½ä¸­...</div>
              <div class="currency-right"><input type="text" id="input-${code}" class="currency-input" placeholder="0.00"
                oninput="onInputChange('${code}')" onfocus="onInputFocus('${code}')"></div>
            </div>`;
        });

        // æ¸²æŸ“å®Œæˆååˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        initSortable();
      }

      async function fetchExchangeRates(){
        updateStatus('loading', '<div class="spinner"></div> æ­£åœ¨è·å–æœ€æ–°æ±‡ç‡æ•°æ®...');
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;

        for (const source of rateSources) {
          try {
            const r = await fetch(source.url);
            if (!r.ok) throw new Error(`Fetch failed for ${source.name}`);

            const d = await r.json();
            let rates = source.parseRates(d);

            if (!source.isUSD) {
              // è½¬æ¢ä¸º USD åŸºå‡†
              const eurToUsdRate = rates['USD'];
              if (!eurToUsdRate) throw new Error("Missing USD rate for conversion.");

              const usdRates = {};
              for (const code in rates) {
                usdRates[code] = rates[code] / eurToUsdRate;
              }
              exchangeRates = usdRates;
            } else {
              exchangeRates = rates;
            }

            exchangeRates['USD'] = 1; // ç¡®ä¿åŸºå‡†æ˜¯ 1

            updateStatus('success', `æ±‡ç‡æ•°æ®è·å–æˆåŠŸ (æ¥æº: ${source.name})`);
            updateRateDisplays();
            document.getElementById('lastUpdated').textContent = `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')} (æ¥æº: ${source.name})`;
            refreshBtn.disabled = false;
            refreshBtn.innerHTML='ğŸ”„ åˆ·æ–°æ±‡ç‡';
            return; // æˆåŠŸåé€€å‡ºå¾ªç¯

          } catch (e) {
            console.error(`å°è¯•ä» ${source.name} è·å–å¤±è´¥:`, e);
            // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæº
          }
        }

        // æ‰€æœ‰æºéƒ½å¤±è´¥äº†
        useSimulatedRates();
        refreshBtn.disabled = false;
        refreshBtn.innerHTML='ğŸ”„ åˆ·æ–°æ±‡ç‡';
      }

      function useSimulatedRates(){
        exchangeRates = {
          USD:1, EUR:0.85, CNY:7.25, JPY:148.5, GBP:0.78, AUD:1.52,
          CAD:1.36, CHF:0.91, HKD:7.8, SGD:1.35, KRW:1320, INR:83.2,
          THB:34.1, VND:23600,
          RUB:90.5, ZAR:19.7, TWD:30.5, IDR:15500, MYR:4.7, PHP:56.2,
          TRY:27.0
        };

        updateStatus('error','æ±‡ç‡æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®');
        updateRateDisplays();
        document.getElementById('lastUpdated').textContent=`æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')} (æ¨¡æ‹Ÿ)`;
      }

      function updateStatus(t,m){const el=document.getElementById('status');el.className=`status ${t}`;el.innerHTML=m;}
      function updateRateDisplays(){
        currentCurrencyCodes.forEach(c=>{
          const el=document.getElementById(`rate-${c}`);
          if(!el) return; // è·³è¿‡æœªæ¸²æŸ“çš„å…ƒç´ 

          if(c===baseCurrency) el.textContent='æ±‡ç‡: 1.0000 (åŸºå‡†) (ç‚¹å‡»æŸ¥çœ‹)';
          else{
            if(!exchangeRates[baseCurrency] || !exchangeRates[c]) {
                el.textContent = 'æ±‡ç‡: æ•°æ®ä¸å¯ç”¨';
                return;
            }
            const r=exchangeRates[c]/exchangeRates[baseCurrency];
            el.textContent=r?`æ±‡ç‡: ${r.toFixed(4)} (ç‚¹å‡»æŸ¥çœ‹)`:'æ±‡ç‡: æ•°æ®ä¸å¯ç”¨';
          }
        });
      }

      function onInputChange(c){
        if(isUpdating || !exchangeRates[c]) return;
        const val=parseFloat(document.getElementById(`input-${c}`).value.replace(/,/g,'')) || 0;
        baseCurrency=c; updateRateDisplays(); isUpdating=true;
        currentCurrencyCodes.forEach(k=>{
          if(k!==c){
            if(!exchangeRates[k] || !exchangeRates[c]) {
                document.getElementById(`input-${k}`).value = ''; // æ•°æ®ä¸å¯ç”¨åˆ™æ¸…ç©º
                return;
            }
            const converted = val*exchangeRates[k]/exchangeRates[c];
            document.getElementById(`input-${k}`).value = formatNumber(converted);
          }
        });
        isUpdating=false;
      }

      function onInputFocus(c){
        baseCurrency=c; updateRateDisplays();
        const input = document.getElementById(`input-${c}`);
        input.value = input.value.replace(/,/g,''); // å»æ‰åƒåˆ†ä½æ–¹ä¾¿ç¼–è¾‘
      }

      async function refreshRates(){
        const b=document.getElementById('refreshBtn');b.disabled=true;b.innerHTML='<div class="spinner"></div>åˆ·æ–°ä¸­...';
        await fetchExchangeRates();
        // åˆ·æ–°åï¼Œé‡æ–°è®¡ç®—å½“å‰è¾“å…¥çš„è´§å¸
        const activeInputCode = currentCurrencyCodes.find(k=>{
            const val = document.getElementById(`input-${k}`).value.replace(/,/g,'');
            return parseFloat(val) > 0;
        });
        if(activeInputCode) onInputChange(activeInputCode);
        else if (document.getElementById(`input-${baseCurrency}`).value.length > 0) onInputChange(baseCurrency);

        b.disabled=false;b.innerHTML='ğŸ”„ åˆ·æ–°æ±‡ç‡';
      }

      // ------------------- å†å²å›¾è¡¨é€»è¾‘ä¼˜åŒ– -------------------

      // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å¤©æ•°è®¡ç®—èµ·å§‹æ—¥æœŸ
      function getDaysFromToday(days) {
          if (days === 0) return 0; // 0 days means today for current rate
          const d = new Date();
          // Frankfurter API ä¸æ”¯æŒå½“å¤©æ•°æ®ï¼Œæ‰€ä»¥å†å²æ•°æ®åº”è‡³å°‘ä»æ˜¨å¤©å¼€å§‹
          if (days > 0) d.setDate(d.getDate() - days);
          return d;
      }

      // å°è£…ï¼šæ˜¾ç¤ºå†å²å›¾è¡¨æ¨¡æ€æ¡†
      function showHistoryChart(targetCode, days = 30){
          currentTarget = targetCode; // ä¿å­˜å½“å‰ç›®æ ‡è´§å¸

          if(targetCode === baseCurrency){
              // å¯¹äºåŸºå‡†è´§å¸ï¼Œæ— éœ€è¯·æ±‚ APIï¼Œç›´æ¥æ˜¾ç¤ºæç¤º
              document.getElementById('modalTitle').textContent = `${baseCurrency} (åŸºå‡†)`;
              const ctx = document.getElementById('historyChart').getContext('2d');
              if(myChart) myChart.destroy();
              ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); // æ¸…ç©ºç”»å¸ƒ
              ctx.font = '16px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#24374a';
              ctx.fillText('åŸºå‡†è´§å¸æ’å®šä¸º1ï¼Œæ— å†å²æ³¢åŠ¨', ctx.canvas.width/2, ctx.canvas.height/2);
              document.getElementById('historyStats').innerHTML = '';
              document.getElementById('historyModal').classList.add('active');

              // ç¡®ä¿æŒ‰é’®é€‰ä¸­çŠ¶æ€æ­£ç¡®
              document.querySelectorAll('#timeRangeButtons button').forEach(btn => {
                  btn.classList.remove('active');
              });

              return;
          }

          const modal=document.getElementById('historyModal');
          modal.addEventListener('click', (e) => { if (e.target === modal) closeHistoryModal(); });
          modal.classList.add('active');

          loadHistory(targetCode, days);
      }

      // å°è£…ï¼šåŠ è½½å†å²æ•°æ®å’Œæ¸²æŸ“å›¾è¡¨
      async function loadHistory(targetCode, days){
          const modalTitle = document.getElementById('modalTitle');
          const chartCanvas = document.getElementById('historyChart');
          const ctx=chartCanvas.getContext('2d');
          const statsDiv = document.getElementById('historyStats');

          if(myChart) myChart.destroy();
          ctx.clearRect(0,0,chartCanvas.width,chartCanvas.height); // æ¸…ç©ºç”»å¸ƒ

          // ************ ä¿®å¤ï¼šæ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€ ************
          document.querySelectorAll('#timeRangeButtons button').forEach(btn => {
              btn.classList.remove('active');
              if(parseInt(btn.dataset.days) === days) {
                  btn.classList.add('active');
              }
          });
          // **********************************************

          // ä¸´æ—¶æ˜¾ç¤ºåŠ è½½ä¸­
          modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡ (æ­£åœ¨åŠ è½½...)`;
          statsDiv.innerHTML = `<div class="status loading" style="width:100%"><div class="spinner"></div> æ­£åœ¨è·å–å†å²æ•°æ®...</div>`;

          try{
              const data=await historyApi.fetchHistory(baseCurrency, targetCode, days);

              if(data.length === 0){
                  modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡ (è¿‘${days}å¤©)`;
                  statsDiv.innerHTML = '';
                  ctx.font = '16px sans-serif';
                  ctx.textAlign = 'center';
                  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--status-error-color').trim() || '#c62828';
                  ctx.fillText('å†å²æ•°æ®è·å–å¤±è´¥æˆ–æ— æ•°æ®', chartCanvas.width/2, chartCanvas.height/2);
                  return;
              }

              // 1. æ•°æ®å‡†å¤‡
              const labels=data.map(d=>new Date(d.date).toLocaleDateString('zh-CN',{month:'numeric',day:'numeric', year: days >= 365 ? '2-digit' : undefined}));
              const rates=data.map(d=>d.rate);

              // 2. ç»Ÿè®¡æ•°æ®
              const minRate = Math.min(...rates);
              const maxRate = Math.max(...rates);
              const firstRate = rates[0];
              const lastRate = rates[rates.length - 1];
              const change = lastRate - firstRate;
              const changePercent = (change / firstRate) * 100;

              // æŸ¥æ‰¾æœ€é«˜ç‚¹å’Œæœ€ä½ç‚¹ç´¢å¼•
              const minIndex = rates.indexOf(minRate);
              const maxIndex = rates.indexOf(maxRate);

              // Chart.js é…ç½®ï¼šæ ‡è®°ç‚¹
              const pointBackgroundColors = rates.map((rate, index) => {
                  if (index === minIndex) return getComputedStyle(document.documentElement).getPropertyValue('--stat-negative').trim() || '#c62828'; // æœ€ä½ç‚¹çº¢è‰²
                  if (index === maxIndex) return getComputedStyle(document.documentElement).getPropertyValue('--stat-positive').trim() || '#2e7d32'; // æœ€é«˜ç‚¹ç»¿è‰²
                  return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#3a8edb'; // å…¶ä»–ç‚¹
              });
              const pointRadii = rates.map((rate, index) => {
                  if (index === minIndex || index === maxIndex) return 6; // çªå‡ºæ˜¾ç¤º
                  return 3;
              });

              // 3. æ¸²æŸ“å›¾è¡¨
              const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#3a8edb';
              const chartColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#24374a';

              myChart=new Chart(ctx,{
                type:'line',
                data:{
                    labels,
                    datasets:[{
                        label:`${baseCurrency}â†’${targetCode}`,
                        data:rates,
                        borderColor:accent,
                        backgroundColor:accent+'30',
                        fill:true,
                        tension:0.2,
                        pointRadius: pointRadii,
                        pointBackgroundColor: pointBackgroundColors,
                    }]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    scales: {
                        x: {
                            ticks: {
                                color: chartColor,
                                maxTicksLimit: 10 // é™åˆ¶æ¨ªåæ ‡æ ‡ç­¾æ•°é‡ï¼Œå°¤å…¶å¯¹1å¹´/5å¹´å›¾è¡¨
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--card-border').trim()
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) { return value.toFixed(4); },
                                color: chartColor
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--card-border').trim()
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` æ±‡ç‡: ${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    }
                }
              });
              
              // 4. æ¸²æŸ“ç»Ÿè®¡æ•°æ®
              const changeClass = change > 0 ? 'stat-change-up' : change < 0 ? 'stat-change-down' : change === 0 ? 'stat-change-neutral' : '';
              const changeSign = change > 0 ? 'â†‘' : change < 0 ? 'â†“' : '';

              const statHtml = `
                  <div class="stat-item">
                      <div>èµ·å§‹æ±‡ç‡ (${labels[0]}):</div>
                      <div class="stat-value">${firstRate.toFixed(4)}</div>
                  </div>
                  <div class="stat-item">
                      <div>ç»“æŸæ±‡ç‡ (${labels[labels.length-1]}):</div>
                      <div class="stat-value">${lastRate.toFixed(4)}</div>
                  </div>
                  <div class="stat-item">
                      <div>${days}å¤©å˜åŒ–:</div>
                      <div class="stat-value ${changeClass}">${changeSign} ${Math.abs(change).toFixed(4)} (${changePercent.toFixed(2)}%)</div>
                  </div>
                  <div class="stat-item">
                      <div>æœ€é«˜æ±‡ç‡ (${labels[maxIndex]}):</div>
                      <div class="stat-value stat-high">${maxRate.toFixed(4)}</div>
                  </div>
                  <div class="stat-item">
                      <div>æœ€ä½æ±‡ç‡ (${labels[minIndex]}):</div>
                      <div class="stat-value stat-low">${minRate.toFixed(4)}</div>
                  </div>
              `;
              statsDiv.innerHTML = statHtml;
              modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡ (è¿‘${days}å¤©)`;


          }catch(e){
              console.error("Chart Error:", e);
              modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡`;
              statsDiv.innerHTML = '';
              ctx.font = '16px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--status-error-color').trim() || '#c62828';
              ctx.fillText('å†å²æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', chartCanvas.width/2, chartCanvas.height/2);
          }
      }

      function closeHistoryModal(){document.getElementById('historyModal').classList.remove('active'); if(myChart){myChart.destroy(); myChart=null; currentTarget=null;}}

      window.onload=()=>{
        loadThemeUI();
        loadOrder(); // é¡µé¢åŠ è½½æ—¶å…ˆè¯»å–ç¼“å­˜çš„æ’åº
        createCurrencyItems(); // æ ¹æ®æ’åºæ¸²æŸ“åˆ—è¡¨
        fetchExchangeRates();
      };
    </script>
</body>
</html>
